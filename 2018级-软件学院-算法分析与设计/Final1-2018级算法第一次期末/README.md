# Final1-2018级算法第一次期末

# 幸运盒

时间限制: 3000 ms 内存限制: 65536 kb

总通过人数: 5 总提交人数: 5

## 题目描述

小明有 n 个幸运盒，每次运转一个盒子的结果要么出现糖果，要么出现芥末。每一轮，小明可以每次选择恰好 𝑘k 个盒子一起运转，每个盒子有 p% 的概率开出糖果，(100−p)% 的概率开出芥末；或者他可以选择这一轮使用法术：选择恰好 t 个盒子，对这些盒子的开出糖果的概率进行调整，使这些盒子分别有 p%，(min(p+1,100))%，……，(min(p+t−1,100))% 的概率获得糖果；当然，他也可以什么都不做，放弃这一轮。

简单来说，就是

一开始有n个盒子，最开始的时候盒子都是空的。

可以进行m次操作，每次操作有三种选择：

1. 什么也不做，此时盒子的状态维持不变
2. 选择k个盒子，清空里面的东西，每个盒子现在有 p% 的概率开出糖果，然后重新开启它们
3. 选择t个盒子，清空里面的东西，每个盒子现在有 p%，(min(p+1,100))%，……，(min(p+t−1,100))% 的概率获得糖果，然后重新开启它们

小明很聪明，每一轮都会选择最优的策略运转这些盒子，包括选择 k 个盒子重新运转，或者选择 t 个盒子使用法术，亦或是放弃这一轮的运转。他可以进行 m 轮操作，在所有操作结束之前他不能拿走盒子里的东西。他想知道 m 轮操作之后，他期望获得多少的糖果。

## 输入

第一行一个整数 T，表示数据组数。

对每组数据，输入一行五个整数：n，m，t，k，p，分别表示盒子的数量 n、运转轮数 m、使用法术需要选择的盒子数量 t、不使用法术需要选择的盒子数量 k，以及 p 表示初始概率 p%。

1≤T≤100,1≤n≤500,1≤m≤500,1≤t≤20,t≤k≤n,1≤p≤100,

对于 T 组数据中 90% 组的数据，1≤n≤50， 1≤m≤50，1≤t≤10。

## 输出

每组测试数据输出一行，一个 5 位小数，表示最佳策略下的期望。

## 输入样例

```
2
500 500 19 300 50
39 42 4 27 86
```

## 输出样例

```
497.89734
39.00000
```

## 思路

**这是一道期望dp的问题，较为综合，需要结合概率dp的相关状态转移来做**

**因为状态转移不能光有一个期望，预处理概率这个过程无论如何是需要的**

**而每次的转移则需要计算法术和旋转所带来的不同情况的概率**



**首先二维数组可以预处理运转k个盒子出现糖的数量i对应的概率 spin(k, i) (法术同理,设为magic,其原理基本是一致的，除了spin的概率全都是一样的，而magic是会变化的，具体就不再赘述了)**

 然后在考虑状态转移的时候，需要考虑每一轮。

 **首先记录有多少个盒子开出了糖果，那么每一轮都可以枚举3种操作，开出了多少糖果**

 **然而不能直接的贪心，所以需要计算具体数值和对应的概率**

 **这一步较为基础，有初始的spin(1, 0)=1-p,spin(1, 1)=p,就不难得到**

- **spin(i, 0) = spin(i-1, 0)\*(1-p)**
- **spin(i, j) = spin(i-1, j)\*(1-p) + spin(i-1, j-1)\*p (j>0)**

**magic也是如出一辙的，但是每一次的概率都不一样，这需要进行一次预处理**



 不是所有的箱子都一定要打开，所以反向推导...

 **假设dp(i,j)是还剩下i轮，而且有j个箱子没有开出糖果时，期望得到的数量**

 **但是需要注意，就算盒子不够了，还是需要尝试两种运转的操作或者啥都不做**

 

 **每次在转移的时候,如果j的数量不小于k或者t的话,直接开箱子就行了**

 假设之前开过**j-x(0<=x<=k)**个箱子，那么从剩下i轮到剩下i-1轮，就是选择了k个箱子,开出了x个糖

 **其期望就是∑((dp(i-1,j-x)+x)\*spin(k,x))** 这个转移倒是不稀奇

 

 **如果j的数量小于k或者t的话,那么实际上就需要动到其他的开过的箱子了**

 假设之前开过**x(0<=x<=k)**个箱子,那么从剩下i轮到剩下i-1轮，需要选择k个箱子,**没有开过的箱子中开出j-x个**

 **然而其他的糖个数不能动，所以实际上必须开出k-x个糖(也就是重新动的箱子还得有k-j个糖才行)**

 **其期望就是∑((dp(i-1,x)+j-x)\*spin(k,k-x))**



**而magic的转换和上面类似，只要稍微更改变量即可得到**

**每一次的dp转移则是dp(i,j)=max(dp(i-1,j), Pspin, Pmagic),dp(i-1,j)则是本轮空过的最大期望，而另外两个分别是运转和法术的最大期望**

 

 **所以最后的dp(m,n)即为所求**



**本题也是考场上十分罕见的零提交的题目，所以奉劝各位在期末不要企图用dp/贪心的难题还提高名词，这需要做的工作量远比图论计算几何FFT来的大= =**

